<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced CSV Location Data Merger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transition: all 0.3s ease;
        }
        
        .upload-box:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            transform: translateY(-2px);
        }
        
        .upload-box h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .file-input {
            margin: 10px 0;
            padding: 10px 20px;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .settings-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #cccccc;
        }
        
        .results {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }
        
        .results h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .status.info {
            background: rgba(23, 162, 184, 0.1);
            color: #0c5460;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }
        
        .status.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }
        
        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .preview-container {
            max-height: 500px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .confidence-high { background-color: rgba(40, 167, 69, 0.1); }
        .confidence-medium { background-color: rgba(255, 193, 7, 0.1); }
        .confidence-low { background-color: rgba(220, 53, 69, 0.1); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Enhanced CSV Location Data Merger</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">Advanced location matching with preview, editing, and comprehensive verification</p>
        
        <div class="upload-section">
            <div class="upload-box">
                <h3>üìç Cities CSV File</h3>
                <p>Upload your cities data with location information</p>
                <input type="file" id="citiesFile" accept=".csv" class="file-input">
                <div id="citiesStatus"></div>
            </div>
            
            <div class="upload-box">
                <h3>üë• Bio Data CSV File</h3>
                <p>Upload your bio/influencer data</p>
                <input type="file" id="bioFile" accept=".csv" class="file-input">
                <div id="bioStatus"></div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>üîß Matching Settings</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="strictMode" checked>
                    <label for="strictMode">Strict matching (higher accuracy)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="requireStateMatch" checked>
                    <label for="requireStateMatch">Require state verification</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="validateAbbreviations" checked>
                    <label for="validateAbbreviations">Validate abbreviations</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="contextualMatching" checked>
                    <label for="contextualMatching">Use contextual keywords</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="prioritizeBioData" checked>
                    <label for="prioritizeBioData">Prioritize bio_data column</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="crossValidation">
                    <label for="crossValidation">Cross-validate matches</label>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="previewBtn" class="btn btn-warning">üëÅÔ∏è Preview Matches</button>
            <button id="mergeBtn" class="btn btn-primary">üîÑ Process All Data</button>
            <button id="sampleBtn" class="btn btn-info">üß™ Load Sample Data</button>
            <button id="debugBtn" class="btn" style="background: #6c757d; color: white;">üîç Debug Info</button>
        </div>
        
        <div id="debugPanel" class="debug-panel"></div>
        
        <div id="results" class="results" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('preview')">üìä Results</button>
                <button class="tab" onclick="switchTab('details')">üìã Match Details</button>
                <button class="tab" onclick="switchTab('stats')">üìà Statistics</button>
            </div>

            <div id="preview-tab" class="tab-content active">
                <h3>üìä Processing Results</h3>
                <div id="mergeStatus"></div>
                <div id="previewContainer"></div>
            </div>

            <div id="details-tab" class="tab-content">
                <h3>üìã Detailed Match Information</h3>
                <div id="detailsContainer"></div>
            </div>

            <div id="stats-tab" class="tab-content">
                <h3>üìà Comprehensive Statistics</h3>
                <div id="statsContainer"></div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="downloadBtn" class="btn btn-secondary" style="display: none;">üíæ Download Results</button>
                <button id="downloadDetailsBtn" class="btn btn-secondary" style="display: none;">üìã Download Match Report</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let citiesData = null;
        let bioData = null;
        let processedData = null;
        let matchDetails = null;
        let cityIndex = new Map();
        let stateIndex = new Map();

        // US States mapping
        const US_STATES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California', 'CO': 'Colorado',
            'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
            'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana',
            'ME': 'Maine', 'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
            'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
            'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina', 'SD': 'South Dakota',
            'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
            'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        // Location context keywords
        const LOCATION_KEYWORDS = [
            'from', 'in', 'at', 'based', 'located', 'live', 'lives', 'resident', 'living',
            'born', 'raised', 'hometown', 'home', 'city', 'state', 'area', 'place',
            'üìç', 'üìå', 'üó∫Ô∏è', 'üèôÔ∏è', 'üè†', 'üåÜ'
        ];

        // Event listeners setup
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateButtonStates();
        });

        function setupEventListeners() {
            document.getElementById('citiesFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) parseCSV(file, 'cities');
            });

            document.getElementById('bioFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) parseCSV(file, 'bio');
            });

            document.getElementById('previewBtn').onclick = function(e) {
                e.preventDefault();
                previewMatches();
            };

            document.getElementById('mergeBtn').onclick = function(e) {
                e.preventDefault();
                processAllData();
            };

            document.getElementById('sampleBtn').onclick = function(e) {
                e.preventDefault();
                loadSampleData();
            };

            document.getElementById('debugBtn').onclick = function(e) {
                e.preventDefault();
                toggleDebugInfo();
            };

            document.getElementById('downloadBtn').onclick = function(e) {
                e.preventDefault();
                downloadResults();
            };

            document.getElementById('downloadDetailsBtn').onclick = function(e) {
                e.preventDefault();
                downloadMatchDetails();
            };
        }

        function parseCSV(file, type) {
            const statusDiv = document.getElementById(type + 'Status');
            statusDiv.innerHTML = '<div class="status info">üìÅ Parsing CSV file...</div>';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${results.errors[0].message}</div>`;
                        return;
                    }

                    if (type === 'cities') {
                        const originalCount = results.data.length;
                        citiesData = results.data.filter(row => row && (row.city || row.city_ascii));
                        buildLocationIndexes();
                        statusDiv.innerHTML = `
                            <div class="status success">
                                ‚úÖ Cities CSV loaded<br>
                                üìä Total rows: <strong>${originalCount}</strong><br>
                                üèôÔ∏è Valid cities: <strong>${citiesData.length}</strong><br>
                                üóÇÔ∏è Columns: <strong>${Object.keys(results.data[0] || {}).length}</strong>
                            </div>`;
                    } else {
                        const originalCount = results.data.length;
                        bioData = results.data.filter(row => row && Object.values(row).some(val => val && val.toString().trim()));
                        statusDiv.innerHTML = `
                            <div class="status success">
                                ‚úÖ Bio CSV loaded<br>
                                üìä Total rows: <strong>${originalCount}</strong><br>
                                üë• Valid records: <strong>${bioData.length}</strong><br>
                                üóÇÔ∏è Columns: <strong>${Object.keys(results.data[0] || {}).length}</strong>
                            </div>`;
                    }

                    updateButtonStates();
                },
                error: function(error) {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                }
            });
        }

        function buildLocationIndexes() {
            cityIndex.clear();
            stateIndex.clear();

            citiesData.forEach(city => {
                if (!city) return;

                // Build city index
                if (city.city) {
                    const key = city.city.toLowerCase().trim();
                    if (!cityIndex.has(key)) cityIndex.set(key, []);
                    cityIndex.get(key).push(city);
                }

                if (city.city_ascii && city.city_ascii !== city.city) {
                    const key = city.city_ascii.toLowerCase().trim();
                    if (!cityIndex.has(key)) cityIndex.set(key, []);
                    cityIndex.get(key).push(city);
                }

                // Build state index
                if (city.state_name) {
                    const key = city.state_name.toLowerCase().trim();
                    if (!stateIndex.has(key)) stateIndex.set(key, []);
                    stateIndex.get(key).push(city);
                }

                if (city.state_id) {
                    const key = city.state_id.toLowerCase().trim();
                    if (!stateIndex.has(key)) stateIndex.set(key, []);
                    stateIndex.get(key).push(city);
                }
            });
        }

        function updateButtonStates() {
            const previewBtn = document.getElementById('previewBtn');
            const mergeBtn = document.getElementById('mergeBtn');
            
            const ready = citiesData && bioData && citiesData.length > 0 && bioData.length > 0;
            
            if (ready) {
                previewBtn.disabled = false;
                mergeBtn.disabled = false;
                previewBtn.textContent = `üëÅÔ∏è Preview Matches (${bioData.length} records)`;
                mergeBtn.textContent = `üîÑ Process All Data (${bioData.length} records)`;
            } else {
                previewBtn.disabled = false; // Always enable for better UX
                mergeBtn.disabled = false;
                
                let citiesMsg = citiesData ? `${citiesData.length} cities loaded` : 'Upload cities CSV';
                let bioMsg = bioData ? `${bioData.length} bio records loaded` : 'Upload bio CSV';
                
                previewBtn.textContent = `üëÅÔ∏è Preview (${citiesMsg})`;
                mergeBtn.textContent = `üîÑ Process (${bioMsg})`;
            }
        }

        function findLocationInText(text) {
            if (!text || typeof text !== 'string') return null;
            
            const textLower = text.toLowerCase();
            let bestMatch = null;
            let highestScore = 0;

            // Extract words for matching
            const words = textLower.split(/[\s,;.:!?\-_\(\)\[\]{}|\/\\'"]+/)
                .filter(word => word && word.length > 1);

            // Check for city matches first (highest priority)
            for (const word of words) {
                if (cityIndex.has(word)) {
                    const cities = cityIndex.get(word);
                    for (const city of cities) {
                        let score = 100 + (city.population || 0) / 10000;
                        
                        // Context bonus
                        if (hasLocationContext(text, word)) score += 20;
                        
                        // State verification
                        if (document.getElementById('requireStateMatch').checked) {
                            if (verifyStateInText(text, city)) {
                                score += 30;
                            } else {
                                score -= 15;
                            }
                        }

                        if (score > highestScore) {
                            highestScore = score;
                            bestMatch = {
                                city: city,
                                matchType: 'city',
                                matchedText: word,
                                confidence: score > 120 ? 'high' : score > 80 ? 'medium' : 'low',
                                score: score
                            };
                        }
                    }
                }
            }

            // If no city match and not in strict mode, try state matches
            if (!bestMatch && !document.getElementById('strictMode').checked) {
                for (const word of words) {
                    if (stateIndex.has(word)) {
                        const cities = stateIndex.get(word);
                        const largestCity = cities.reduce((prev, curr) => 
                            (curr.population || 0) > (prev.population || 0) ? curr : prev
                        );

                        const score = 70 + (largestCity.population || 0) / 20000;
                        if (score > highestScore) {
                            highestScore = score;
                            bestMatch = {
                                city: largestCity,
                                matchType: 'state',
                                matchedText: word,
                                confidence: 'medium',
                                score: score
                            };
                        }
                    }

                    // Check state abbreviations
                    if (document.getElementById('validateAbbreviations').checked) {
                        const upperWord = word.toUpperCase();
                        if (US_STATES[upperWord]) {
                            const stateName = US_STATES[upperWord].toLowerCase();
                            if (stateIndex.has(stateName)) {
                                const cities = stateIndex.get(stateName);
                                const largestCity = cities.reduce((prev, curr) => 
                                    (curr.population || 0) > (prev.population || 0) ? curr : prev
                                );

                                const score = 90 + (largestCity.population || 0) / 20000;
                                if (score > highestScore) {
                                    highestScore = score;
                                    bestMatch = {
                                        city: largestCity,
                                        matchType: 'abbreviation',
                                        matchedText: word,
                                        confidence: 'high',
                                        score: score
                                    };
                                }
                            }
                        }
                    }
                }
            }

            return bestMatch;
        }

        function hasLocationContext(text, word) {
            if (!document.getElementById('contextualMatching').checked) return false;
            
            const textLower = text.toLowerCase();
            const wordIndex = textLower.indexOf(word);
            if (wordIndex === -1) return false;

            const contextStart = Math.max(0, wordIndex - 20);
            const contextEnd = Math.min(textLower.length, wordIndex + word.length + 20);
            const context = textLower.substring(contextStart, contextEnd);

            return LOCATION_KEYWORDS.some(keyword => context.includes(keyword));
        }

        function verifyStateInText(text, city) {
            if (!city.state_name && !city.state_id) return false;
            
            const textLower = text.toLowerCase();
            return (city.state_name && textLower.includes(city.state_name.toLowerCase())) ||
                   (city.state_id && textLower.includes(city.state_id.toLowerCase()));
        }

        function previewMatches() {
            if (!citiesData || citiesData.length === 0) {
                alert('‚ùå Please upload cities CSV file first!');
                return;
            }
            
            if (!bioData || bioData.length === 0) {
                alert('‚ùå Please upload bio CSV file first!');
                return;
            }

            const statusDiv = document.getElementById('mergeStatus');
            statusDiv.innerHTML = '<div class="status info">üîç Analyzing first 10 records for preview...</div>';

            const previewData = bioData.slice(0, Math.min(10, bioData.length));
            const results = [];
            const details = [];

            previewData.forEach((record, index) => {
                const result = processRecord(record, index, true);
                results.push(result.record);
                details.push(result.detail);
            });

            displayPreviewResults(results, details);
            document.getElementById('results').style.display = 'block';
        }

        function processAllData() {
            if (!citiesData || citiesData.length === 0) {
                alert('‚ùå Please upload cities CSV file first!');
                return;
            }
            
            if (!bioData || bioData.length === 0) {
                alert('‚ùå Please upload bio CSV file first!');
                return;
            }

            const statusDiv = document.getElementById('mergeStatus');
            statusDiv.innerHTML = `<div class="status info">üîÑ Processing all ${bioData.length} records...</div>`;

            processedData = [];
            matchDetails = [];
            let totalMatches = 0;

            bioData.forEach((record, index) => {
                const result = processRecord(record, index, false);
                processedData.push(result.record);
                matchDetails.push(result.detail);
                
                if (result.record.location_match === 'YES') {
                    totalMatches++;
                }
                
                // Progress update every 100 records
                if ((index + 1) % 100 === 0 || index === bioData.length - 1) {
                    statusDiv.innerHTML = `<div class="status info">üîÑ Processed ${index + 1}/${bioData.length} records... (${totalMatches} matches found)</div>`;
                }
            });

            displayAllResults(processedData, matchDetails, totalMatches);
            document.getElementById('downloadBtn').style.display = 'inline-block';
            document.getElementById('downloadDetailsBtn').style.display = 'inline-block';
            document.getElementById('results').style.display = 'block';
        }

        function processRecord(record, index, isPreview) {
            const result = { ...record };
            const detail = {
                recordIndex: index + 1,
                matchType: 'none',
                match